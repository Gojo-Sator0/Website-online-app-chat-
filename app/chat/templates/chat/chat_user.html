{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid chat-container">
    <div class="row flex-nowrap">
        <!-- Боковая панель выбора чатов -->
        <div class="col-md-3 chat-sidebar p-0 bg-white border-end">
            {% include "chat/chats_list.html" %}
        </div>

        <!-- Окно чата -->
        <div class="col-md-9 chat-window p-3 d-flex flex-column" style="min-width: 0;">
            
            <!-- Шапка чата -->
            {% if other_user %}
                <div class="chat-header d-flex align-items-center justify-content-between">
                    <!-- Левая часть: аватар и информация -->
                    <div class="d-flex align-items-center">
                        <a href="{% url 'accounts:profile' username=other_user.username %}">
                            <img src="{{ other_user.image.url }}" alt="User 1" class="rounded-circle me-3" style="width: 50px; height: 50px;">
                        </a>
                        <div>
                            
                           
                            <h5 class="mb-0">{{ other_user.first_name }} {{ other_user.last_name }}</h5>

                            <div class="text-emerald-400 bg-gray-800 p-2">
                                <span id="online-bool" class="pr-1"></span> 
                            </div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <!-- Иконка без треугольника -->
                        <i class="fas fa-ellipsis-v text-muted me-5" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false"></i>
                        <!-- Выпадающий список -->
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <li><a class="dropdown-item text-danger" href="" id="addUser">Delete chat</a></li>
                        </ul>
                    </div>
                </div>
                
            {% else %}
                <div class="chat-header d-flex align-items-center justify-content-between">
                    <div>
                        {% if chat_group.groupchat_name %}
                            <h5 class="mb-0">{{chat_group.groupchat_name}}</h5>
                        {% else %}
                            <h5 class="mb-0">{{ chatroom_name }}</h5>
                        {% endif %}

                        <div class="text-emerald-400 bg-gray-800 p-2 sticky top-0 z-10">
                            <span id="online-count" class="pr-1"></span> online
                        </div>
                    </div>
                    <div class="dropdown">

                        <!-- Иконка без треугольника -->
                        <i class="fas fa-ellipsis-v text-muted me-5" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false"></i>
                        <!-- Выпадающий список -->
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <li><a class="dropdown-item" href="{% url "chat:edit-group" chat_group.name %}" id="createGroup">Edit</a></li>

                            {% if user == chat_group.admin %}
                                <li><a class="dropdown-item text-danger" href="" id="addUser">Delete chat</a></li>
                            {% endif %}
                        </ul>
                    </div>
                    
                    
                </div>
            {% endif %}
            
            

            <!-- Контейнер сообщений -->
            <div id='chat_container' class="chat-messages flex-grow-1 d-flex flex-column" style="overflow-y: auto;">
                <ul id="chat_messages" class="list-unstyled d-flex flex-column justify-content-end">
                    {% for message in chat_messages reversed %}
                        {% include "chat/chat_message.html" %}
                    {% endfor %}
                </ul>
            </div>

            <!-- Поле ввода сообщения -->
            <div class="chat-input p-2">
                <form id="chat_message_form" 
                    class="d-flex align-items-center gap-2 rounded p-2"
                    hx-ext="ws"
                    ws-connect="/ws/chat/{{chatroom_name}}"
                    ws-send
                    _="on htmx:wsAfterSend reset() me">

                    {% csrf_token %}

                    <i class="fas fa-paperclip text-muted fs-4"></i>
                        <input type="text" class="form-control flex-grow-1" placeholder="Type a message..." name="context" id="id_context" required>
                    <i class="far fa-smile text-muted fs-4"></i>
                    <button class="btn btn-primary d-flex align-items-center justify-content-center">
                        <i class="fas fa-paper-plane fs-5"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}